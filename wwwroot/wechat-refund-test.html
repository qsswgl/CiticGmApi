<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡æœåŠ¡å•†é€€æ¬¾æµ‹è¯• - ABC Payment Gateway</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #555;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group .hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .form-group .required {
            color: #e74c3c;
            margin-left: 2px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
            display: none;
        }

        .result-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-box.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .result-box pre {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .quick-fill {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-fill button {
            padding: 8px 15px;
            background: #e8eaf6;
            border: 1px solid #c5cae9;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-fill button:hover {
            background: #c5cae9;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-badge.online {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.offline {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .btn-group {
                flex-direction: column;
            }

            .quick-fill {
                flex-direction: column;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ å¾®ä¿¡æœåŠ¡å•†é€€æ¬¾æµ‹è¯•</h1>
            <p>ABC Payment Gateway - Wechat Refund API Test</p>
        </div>

        <!-- æœåŠ¡çŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <div class="card-title">
                ğŸ“¡ æœåŠ¡çŠ¶æ€
                <span id="serviceStatus" class="status-badge offline">æ£€æŸ¥ä¸­...</span>
            </div>
            <div id="statusInfo"></div>
        </div>

        <!-- æµ‹è¯•é€‰é¡¹å¡ -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('get')">GET æ–¹å¼é€€æ¬¾</button>
                <button class="tab" onclick="switchTab('post')">POST æ–¹å¼é€€æ¬¾</button>
                <button class="tab" onclick="switchTab('query')">æŸ¥è¯¢é€€æ¬¾</button>
            </div>

            <!-- GET æ–¹å¼é€€æ¬¾è¡¨å• -->
            <div id="tab-get" class="tab-content active">
                <div class="card-title">GET æ–¹å¼é€€æ¬¾ï¼ˆURL å‚æ•°ï¼‰</div>
                
                <div class="quick-fill">
                    <button onclick="fillTestData('get')">ğŸ“ å¡«å……æµ‹è¯•æ•°æ®</button>
                    <button onclick="clearForm('get')">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•</button>
                </div>

                <form id="getForm" onsubmit="submitRefundGet(event)">
                    <div class="form-group">
                        <label>æ•°æ®åº“åç§° <span class="required">*</span></label>
                        <input type="text" name="DBName" placeholder="ä¾‹å¦‚: qsoft782" required>
                        <div class="hint">ä¸šåŠ¡ç³»ç»Ÿæ•°æ®åº“æ ‡è¯†</div>
                    </div>

                    <div class="form-group">
                        <label>è®¢å•æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰<span class="required">*</span></label>
                        <input type="number" name="total_fee" placeholder="ä¾‹å¦‚: 5000" required>
                        <div class="hint">åŸè®¢å•çš„æ€»é‡‘é¢ï¼Œå•ä½ï¼šåˆ†ï¼ˆ100å…ƒ = 10000åˆ†ï¼‰</div>
                    </div>

                    <div class="form-group">
                        <label>é€€æ¬¾é‡‘é¢ï¼ˆåˆ†ï¼‰<span class="required">*</span></label>
                        <input type="number" name="refund_fee" placeholder="ä¾‹å¦‚: 5000" required>
                        <div class="hint">è¦é€€æ¬¾çš„é‡‘é¢ï¼Œå¿…é¡» â‰¤ è®¢å•æ€»é‡‘é¢</div>
                    </div>

                    <div class="form-group">
                        <label>æœåŠ¡å•†å•†æˆ·å· <span class="required">*</span></label>
                        <input type="text" name="mch_id" placeholder="ä¾‹å¦‚: 1286651401ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®ï¼‰">
                        <div class="hint">å¾®ä¿¡åˆ†é…çš„æœåŠ¡å•†å•†æˆ·å·ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä»æœåŠ¡å™¨é…ç½®è¯»å–ï¼‰</div>
                    </div>

                    <div class="form-group">
                        <label>æœåŠ¡å•† AppId</label>
                        <input type="text" name="appid" placeholder="ä¾‹å¦‚: wxc74a6aac13640229ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®ï¼‰">
                        <div class="hint">å¾®ä¿¡åˆ†é…çš„æœåŠ¡å•† AppIdï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä»æœåŠ¡å™¨é…ç½®è¯»å–ï¼‰</div>
                    </div>

                    <div class="form-group">
                        <label>ç‰¹çº¦å•†æˆ·å· <span class="required">*</span></label>
                        <input type="text" name="sub_mch_id" placeholder="ä¾‹å¦‚: 1641962649" required>
                        <div class="hint">å­å•†æˆ·å·</div>
                    </div>

                    <div class="form-group">
                        <label>å¾®ä¿¡è®¢å•å·</label>
                        <input type="text" name="transaction_id" placeholder="ä¾‹å¦‚: 4200002973202601249679270528">
                        <div class="hint">å¾®ä¿¡æ”¯ä»˜è®¢å•å·ï¼ˆä¼˜å…ˆä½¿ç”¨ï¼Œä¸å•†æˆ·è®¢å•å·äºŒé€‰ä¸€ï¼‰</div>
                    </div>

                    <div class="form-group">
                        <label>å•†æˆ·è®¢å•å·</label>
                        <input type="text" name="out_trade_no" placeholder="å•†æˆ·ç³»ç»Ÿå†…éƒ¨è®¢å•å·">
                        <div class="hint">å¾®ä¿¡è®¢å•å·ä¸ºç©ºæ—¶å¿…å¡«</div>
                    </div>

                    <div class="form-group">
                        <label>é€€æ¬¾åŸå› </label>
                        <input type="text" name="refund_desc" placeholder="ä¾‹å¦‚: å®¢æˆ·ç”³è¯·é€€æ¬¾">
                        <div class="hint">é€‰å¡«ï¼Œé»˜è®¤ä¸º"å®¢æˆ·ç”³è¯·é€€æ¬¾"</div>
                    </div>

                    <div class="form-group">
                        <label>é€€æ¬¾é€šçŸ¥ URL</label>
                        <input type="url" name="notify_url" placeholder="https://your-domain.com/notify">
                        <div class="hint">æ¥æ”¶é€€æ¬¾ç»“æœé€šçŸ¥çš„ URL</div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">ğŸš€ å‘èµ·é€€æ¬¾ï¼ˆGETï¼‰</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('get')">é‡ç½®</button>
                    </div>
                </form>

                <div id="getResult" class="result-box"></div>
            </div>

            <!-- POST æ–¹å¼é€€æ¬¾è¡¨å• -->
            <div id="tab-post" class="tab-content">
                <div class="card-title">POST æ–¹å¼é€€æ¬¾ï¼ˆJSON æ ¼å¼ï¼‰</div>
                
                <div class="quick-fill">
                    <button onclick="fillTestData('post')">ğŸ“ å¡«å……æµ‹è¯•æ•°æ®</button>
                    <button onclick="clearForm('post')">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•</button>
                </div>

                <form id="postForm" onsubmit="submitRefundPost(event)">
                    <div class="form-group">
                        <label>JSON è¯·æ±‚ä½“ <span class="required">*</span></label>
                        <textarea name="jsonBody" rows="20" placeholder="è¾“å…¥ JSON æ ¼å¼çš„é€€æ¬¾è¯·æ±‚" required></textarea>
                        <div class="hint">å®Œæ•´çš„ JSON æ ¼å¼è¯·æ±‚ä½“</div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">ğŸš€ å‘èµ·é€€æ¬¾ï¼ˆPOSTï¼‰</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('post')">é‡ç½®</button>
                    </div>
                </form>

                <div id="postResult" class="result-box"></div>
            </div>

            <!-- æŸ¥è¯¢é€€æ¬¾è¡¨å• -->
            <div id="tab-query" class="tab-content">
                <div class="card-title">æŸ¥è¯¢é€€æ¬¾çŠ¶æ€</div>
                
                <div class="quick-fill">
                    <button onclick="fillTestData('query')">ğŸ“ å¡«å……æµ‹è¯•æ•°æ®</button>
                    <button onclick="clearForm('query')">ğŸ—‘ï¸ æ¸…ç©ºè¡¨å•</button>
                </div>

                <form id="queryForm" onsubmit="submitQuery(event)">
                    <div class="form-group">
                        <label>å•†æˆ·é€€æ¬¾å•å· <span class="required">*</span></label>
                        <input type="text" name="out_refund_no" placeholder="ä¾‹å¦‚: RF20260128123456" required>
                        <div class="hint">é€€æ¬¾æ—¶è¿”å›çš„å•†æˆ·é€€æ¬¾å•å·</div>
                    </div>

                    <div class="form-group">
                        <label>æœåŠ¡å•†å•†æˆ·å·</label>
                        <input type="text" name="mch_id" placeholder="ä¾‹å¦‚: 1286651401ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®ï¼‰">
                        <div class="hint">å¯é€‰ï¼Œç•™ç©ºåˆ™ä»æœåŠ¡å™¨é…ç½®è¯»å–</div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-success">ğŸ” æŸ¥è¯¢é€€æ¬¾</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('query')">é‡ç½®</button>
                    </div>
                </form>

                <div id="queryResult" class="result-box"></div>
            </div>
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">è¯·æ±‚å¤„ç†ä¸­...</p>
        </div>
    </div>

    <script>
        // API åŸºç¡€ URL
        const API_BASE = window.location.origin;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            checkServiceStatus();
        });

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServiceStatus() {
            try {
                const healthResponse = await fetch(`${API_BASE}/Wechat/Health`);
                const healthData = await healthResponse.json();

                const statusBadge = document.getElementById('serviceStatus');
                const statusInfo = document.getElementById('statusInfo');

                if (healthData.status === 'è¿è¡Œä¸­') {
                    statusBadge.textContent = 'åœ¨çº¿';
                    statusBadge.className = 'status-badge online';
                    statusInfo.innerHTML = `
                        <p style="color: #155724; margin-top: 10px;">
                            âœ… <strong>${healthData.service}</strong><br>
                            ç‰ˆæœ¬: ${healthData.version}<br>
                            æ—¶é—´: ${healthData.timestamp}
                        </p>
                    `;
                } else {
                    throw new Error('æœåŠ¡å¼‚å¸¸');
                }
            } catch (error) {
                const statusBadge = document.getElementById('serviceStatus');
                const statusInfo = document.getElementById('statusInfo');
                statusBadge.textContent = 'ç¦»çº¿';
                statusBadge.className = 'status-badge offline';
                statusInfo.innerHTML = `<p style="color: #721c24;">âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡</p>`;
            }
        }

        // åˆ‡æ¢é€‰é¡¹å¡
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰é€‰é¡¹å¡å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„é€‰é¡¹å¡
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // å¡«å……æµ‹è¯•æ•°æ®
        function fillTestData(formType) {
            if (formType === 'get') {
                const form = document.getElementById('getForm');
                form.DBName.value = 'qsoft782';
                form.total_fee.value = '5000';
                form.refund_fee.value = '5000';
                // mch_id, appid ç•™ç©ºï¼Œä»é…ç½®è¯»å–
                form.mch_id.value = '';
                form.appid.value = '';
                form.sub_mch_id.value = '1641962649';
                form.transaction_id.value = '4200002973202601249679270528';
                form.refund_desc.value = 'æµ‹è¯•é€€æ¬¾';
            } else if (formType === 'post') {
                const form = document.getElementById('postForm');
                const testData = {
                    dbName: "qsoft782",
                    // mchId, appId, apiKey ç•™ç©ºï¼Œä»é…ç½®è¯»å–
                    subMchId: "1641962649",
                    transactionId: "4200002973202601249679270528",
                    totalFee: 5000,
                    refundFee: 5000,
                    refundDesc: "æµ‹è¯•é€€æ¬¾",
                    notifyUrl: ""
                };
                form.jsonBody.value = JSON.stringify(testData, null, 2);
            } else if (formType === 'query') {
                const form = document.getElementById('queryForm');
                form.out_refund_no.value = 'RF20260128123456';
                // mch_id ç•™ç©ºï¼Œä»é…ç½®è¯»å–
                form.mch_id.value = '';
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm(formType) {
            if (formType === 'get') {
                document.getElementById('getForm').reset();
                document.getElementById('getResult').style.display = 'none';
            } else if (formType === 'post') {
                document.getElementById('postForm').reset();
                document.getElementById('postResult').style.display = 'none';
            } else if (formType === 'query') {
                document.getElementById('queryForm').reset();
                document.getElementById('queryResult').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, type, message, data = null) {
            const resultBox = document.getElementById(elementId);
            resultBox.className = `result-box ${type}`;
            
            let html = `<strong>${message}</strong>`;
            if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            resultBox.innerHTML = html;
            resultBox.style.display = 'block';
        }

        // GET æ–¹å¼æäº¤é€€æ¬¾
        async function submitRefundGet(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // æ„å»º URL å‚æ•°
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                if (value) {
                    params.append(key, value);
                }
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE}/Wechat/Refund?${params.toString()}`);
                const data = await response.json();

                hideLoading();

                if (data.success) {
                    showResult('getResult', 'success', 'âœ… é€€æ¬¾æˆåŠŸï¼', data);
                } else {
                    showResult('getResult', 'error', `âŒ é€€æ¬¾å¤±è´¥: ${data.err_code_des || data.return_msg || 'æœªçŸ¥é”™è¯¯'}`, data);
                }
            } catch (error) {
                hideLoading();
                showResult('getResult', 'error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // POST æ–¹å¼æäº¤é€€æ¬¾
        async function submitRefundPost(event) {
            event.preventDefault();
            
            const form = event.target;
            let jsonBody;

            try {
                jsonBody = JSON.parse(form.jsonBody.value);
            } catch (error) {
                showResult('postResult', 'error', 'âŒ JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥');
                return;
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE}/Wechat/Refund`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jsonBody)
                });

                const data = await response.json();

                hideLoading();

                if (data.success) {
                    showResult('postResult', 'success', 'âœ… é€€æ¬¾æˆåŠŸï¼', data);
                } else {
                    showResult('postResult', 'error', `âŒ é€€æ¬¾å¤±è´¥: ${data.errCodeDes || data.returnMsg || 'æœªçŸ¥é”™è¯¯'}`, data);
                }
            } catch (error) {
                hideLoading();
                showResult('postResult', 'error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }

        // æŸ¥è¯¢é€€æ¬¾
        async function submitQuery(event) {
            event.preventDefault();
            
            const form = event.target;
            const params = new URLSearchParams();
            params.append('out_refund_no', form.out_refund_no.value);
            
            // åªåœ¨æœ‰å€¼æ—¶æ·»åŠ å¯é€‰å‚æ•°
            if (form.mch_id.value) {
                params.append('mch_id', form.mch_id.value);
            }

            showLoading();

            try {
                const response = await fetch(`${API_BASE}/Wechat/QueryRefund?${params.toString()}`);
                const data = await response.json();

                hideLoading();

                if (data.success) {
                    showResult('queryResult', 'success', 'âœ… æŸ¥è¯¢æˆåŠŸï¼', data);
                } else {
                    showResult('queryResult', 'error', `âŒ æŸ¥è¯¢å¤±è´¥: ${data.err_code_des || data.return_msg || 'æœªçŸ¥é”™è¯¯'}`, data);
                }
            } catch (error) {
                hideLoading();
                showResult('queryResult', 'error', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
            }
        }
    </script>
</body>
</html>
