<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­ä¿¡é“¶è¡Œå›½å¯†API - å®Œæ•´æµ‹è¯•æµç¨‹</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }
        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }
        .tab:hover { background: #e0e0e0; }
        .tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active { display: block; }
        
        .workflow-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .step-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 6px;
        }
        .step-card h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .step-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        .step-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        .btn-success { background: linear-gradient(135deg, #28a745 0%, #218838 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-warning { background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .result h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .result pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.6;
            max-height: 400px;
        }
        .result.success { border-left-color: #28a745; }
        .result.error { border-left-color: #dc3545; }
        .result.warning { border-left-color: #ffc107; }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .info-box strong { color: #1976d2; }
        .info-box code {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', monospace;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        
        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: #f1f3f5;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Consolas', monospace;
        }
        .log-entry.info { border-left: 3px solid #2196f3; }
        .log-entry.success { border-left: 3px solid #28a745; }
        .log-entry.error { border-left: 3px solid #dc3545; }
        .log-entry.warning { border-left: 3px solid #ffc107; }
        
        .copy-btn {
            float: right;
            padding: 4px 12px;
            font-size: 12px;
            background: #6c757d;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .copy-btn:hover { background: #5a6268; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ä¸­ä¿¡é“¶è¡Œå›½å¯†API - å®Œæ•´æµ‹è¯•æµç¨‹</h1>
            <p>åŸºäº WechatPayTestView.swift çš„æµ‹è¯•åœºæ™¯ | SM2/SM3/SM4 åŠ å¯†ç®—æ³•</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab(0)">ğŸ“‹ å®Œæ•´æµç¨‹æµ‹è¯•</div>
            <div class="tab" onclick="switchTab(1)">ğŸ”‘ å¯†é’¥é…ç½®</div>
            <div class="tab" onclick="switchTab(2)">ğŸ§ª å•æ­¥æµ‹è¯•</div>
            <div class="tab" onclick="switchTab(3)">ğŸ“– APIæ–‡æ¡£</div>
        </div>

        <!-- Tab 0: å®Œæ•´æµç¨‹æµ‹è¯• -->
        <div class="tab-content active">
            <div class="info-box">
                <strong>æµ‹è¯•åœºæ™¯ï¼š</strong>æ¨¡æ‹Ÿå¾®ä¿¡æ”¯ä»˜è¯·æ±‚çš„å®Œæ•´åŠ å¯†æµç¨‹
                <br><strong>æµç¨‹æ­¥éª¤ï¼š</strong>
                <code>ç”ŸæˆSM4å¯†é’¥</code> â†’ <code>SM4åŠ å¯†ä¸šåŠ¡æŠ¥æ–‡</code> â†’ <code>SM2åŠ å¯†SM4å¯†é’¥</code> â†’ <code>SM2ç­¾ååŸæ–‡</code> â†’ <code>å‘é€è¯·æ±‚</code> â†’ <code>SM2è§£å¯†è¿”å›å¯†é’¥</code> â†’ <code>SM4è§£å¯†è¿”å›æŠ¥æ–‡</code>
            </div>

            <div class="workflow-steps">
                <div class="step-card">
                    <h3><span class="step-number">1</span> å‡†å¤‡ä¸šåŠ¡å‚æ•°</h3>
                    <p>é…ç½®å•†æˆ·å·ã€è®¢å•å·ã€é‡‘é¢ç­‰ä¸šåŠ¡ä¿¡æ¯</p>
                </div>
                <div class="step-card">
                    <h3><span class="step-number">2</span> SM4åŠ å¯†</h3>
                    <p>ä½¿ç”¨éšæœºç”Ÿæˆçš„SM4å¯†é’¥åŠ å¯†ä¸šåŠ¡JSONæŠ¥æ–‡</p>
                </div>
                <div class="step-card">
                    <h3><span class="step-number">3</span> SM2åŠ å¯†å¯†é’¥</h3>
                    <p>ä½¿ç”¨ä¸­ä¿¡å…¬é’¥åŠ å¯†SM4å¯†é’¥ï¼Œç”ŸæˆencryptSessionKey</p>
                </div>
                <div class="step-card">
                    <h3><span class="step-number">4</span> SM2ç­¾å</h3>
                    <p>ä½¿ç”¨å•†æˆ·ç§é’¥å¯¹åŸå§‹ä¸šåŠ¡æŠ¥æ–‡ç­¾å</p>
                </div>
                <div class="step-card">
                    <h3><span class="step-number">5</span> å‘é€è¯·æ±‚</h3>
                    <p>å°†åŠ å¯†æ•°æ®å’Œç­¾åå‘é€åˆ°ä¸­ä¿¡ç½‘å…³</p>
                </div>
                <div class="step-card">
                    <h3><span class="step-number">6</span> è§£å¯†å“åº”</h3>
                    <p>ä½¿ç”¨å•†æˆ·ç§é’¥è§£å¯†å“åº”ä¸­çš„SM4å¯†é’¥ï¼Œå†è§£å¯†å“åº”æŠ¥æ–‡</p>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="workflowProgress"></div>
            </div>

            <div class="form-group">
                <label>ä¸šåŠ¡å‚æ•°é…ç½® (JSONæ ¼å¼)ï¼š</label>
                <textarea id="bizParams" rows="12">{
  "mchId": "731691000000096",
  "appid": "wx3f64e658810cca0f",
  "attach": "test",
  "body": "æµ‹è¯•å•†å“",
  "notifyUrl": "https://www.test.com/notify",
  "outTradeNo": "ORDER${timestamp}",
  "subAppid": "wx3f64e658810cca0f",
  "totalFee": 1,
  "mchCreateIp": "127.0.0.1",
  "deviceInfo": "WEBTEST",
  "terminalInfo": {"terminal_id":"C8000023","terminal_type":"11"}
}</textarea>
            </div>

            <div class="btn-group">
                <button class="btn-success" onclick="runFullWorkflow()">ğŸš€ è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•</button>
                <button class="btn-secondary" onclick="clearWorkflowLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <button class="btn-warning btn-small" onclick="fillTestData()">ğŸ“ å¡«å……æµ‹è¯•æ•°æ®</button>
            </div>

            <div id="workflowLog" style="margin-top: 20px;"></div>
        </div>

        <!-- Tab 1: å¯†é’¥é…ç½® -->
        <div class="tab-content">
            <div class="info-box">
                <strong>å¯†é’¥ç®¡ç†ï¼š</strong>é…ç½®æµ‹è¯•æ‰€éœ€çš„å…¬é’¥ã€ç§é’¥å’Œå¯†ç ã€‚å¯†é’¥å°†ä¿å­˜åœ¨æµè§ˆå™¨ localStorage ä¸­ã€‚
            </div>

            <h3 style="margin-bottom: 15px;">ğŸ” ä¸­ä¿¡é“¶è¡Œå…¬é’¥ï¼ˆç”¨äºåŠ å¯†ï¼‰</h3>
            <div class="form-group">
                <label>ä¸­ä¿¡å…¬é’¥ (X509 Base64æ ¼å¼)ï¼š</label>
                <textarea id="citicPublicKey" rows="8"></textarea>
            </div>

            <h3 style="margin: 30px 0 15px 0;">ğŸ”‘ å•†æˆ·ç§é’¥ï¼ˆç”¨äºç­¾åå’Œè§£å¯†ï¼‰</h3>
            <div class="form-group">
                <label>å•†æˆ·ç§é’¥ (Base64æ ¼å¼)ï¼š</label>
                <textarea id="merchantPrivateKey" rows="6"></textarea>
            </div>
            <div class="form-group">
                <label>å•†æˆ·ç§é’¥å¯†ç ï¼š</label>
                <input type="password" id="merchantPassword" placeholder="ä¾‹å¦‚: A1SttKLQG3bIh5Bk">
            </div>

            <div class="btn-group">
                <button class="btn-success" onclick="saveKeys()">ğŸ’¾ ä¿å­˜å¯†é’¥é…ç½®</button>
                <button class="btn-secondary" onclick="loadKeys()">ğŸ“¥ åŠ è½½å¯†é’¥</button>
                <button class="btn-warning" onclick="loadDefaultKeys()">ğŸ”§ åŠ è½½é»˜è®¤æµ‹è¯•å¯†é’¥</button>
                <button class="btn-danger" onclick="clearKeys()">ğŸ—‘ï¸ æ¸…ç©ºå¯†é’¥</button>
            </div>

            <div id="keyResult"></div>
        </div>

        <!-- Tab 2: å•æ­¥æµ‹è¯• -->
        <div class="tab-content">
            <div class="info-box">
                <strong>å•æ­¥è°ƒè¯•ï¼š</strong>åˆ†æ­¥æ‰§è¡ŒåŠ å¯†æµç¨‹ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚æ¯ä¸ªæ­¥éª¤éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•ã€‚
            </div>

            <div class="workflow-steps">
                <div class="step-card">
                    <h3><span class="step-number">1</span> ç”ŸæˆSM4å¯†é’¥</h3>
                    <button class="btn-small" onclick="testGenerateSM4Key()">ç”Ÿæˆ</button>
                    <input type="text" id="sm4KeyStep" readonly style="margin-top:10px" placeholder="32ä½Hex">
                </div>
                
                <div class="step-card">
                    <h3><span class="step-number">2</span> SM4åŠ å¯†ä¸šåŠ¡æŠ¥æ–‡</h3>
                    <textarea id="plainTextStep" rows="3" placeholder='{"test":"data"}'></textarea>
                    <button class="btn-small" style="margin-top:5px" onclick="testSM4Encrypt()">åŠ å¯†</button>
                    <textarea id="sm4CipherStep" rows="2" readonly style="margin-top:5px"></textarea>
                </div>
                
                <div class="step-card">
                    <h3><span class="step-number">3</span> SM2åŠ å¯†SM4å¯†é’¥</h3>
                    <button class="btn-small" onclick="testSM2EncryptKey()">åŠ å¯†å¯†é’¥</button>
                    <textarea id="sessionKeyStep" rows="2" readonly style="margin-top:5px"></textarea>
                </div>
                
                <div class="step-card">
                    <h3><span class="step-number">4</span> SM2ç­¾ååŸæ–‡</h3>
                    <button class="btn-small" onclick="testSM2SignStep()">ç­¾å</button>
                    <textarea id="signatureStep" rows="2" readonly style="margin-top:5px"></textarea>
                </div>
                
                <div class="step-card">
                    <h3><span class="step-number">5</span> SM2è§£å¯†å¯†é’¥</h3>
                    <input type="text" id="encryptedKeyInput" placeholder="è¾“å…¥åŠ å¯†çš„SessionKey" style="margin-bottom:5px">
                    <button class="btn-small" onclick="testSM2DecryptKey()">è§£å¯†</button>
                    <input type="text" id="decryptedKeyStep" readonly style="margin-top:5px">
                </div>
                
                <div class="step-card">
                    <h3><span class="step-number">6</span> SM4è§£å¯†æŠ¥æ–‡</h3>
                    <textarea id="cipherTextDecryptStep" rows="2" placeholder="è¾“å…¥å¯†æ–‡" style="margin-bottom:5px"></textarea>
                    <button class="btn-small" onclick="testSM4DecryptStep()">è§£å¯†</button>
                    <textarea id="decryptedTextStep" rows="2" readonly style="margin-top:5px"></textarea>
                </div>
            </div>

            <div id="stepResult"></div>
        </div>

        <!-- Tab 3: APIæ–‡æ¡£ -->
        <div class="tab-content">
            <div class="info-box">
                <strong>APIæ–‡æ¡£ï¼š</strong>æŸ¥çœ‹å®Œæ•´çš„æ¥å£æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
            </div>

            <h3 style="margin-bottom: 15px;">ğŸ“š å¿«é€Ÿé“¾æ¥</h3>
            <div class="btn-group">
                <button onclick="window.open('https://citic.qsgl.net/swagger', '_blank')">ğŸ“– Swagger æ–‡æ¡£</button>
                <button onclick="window.open('https://github.com/qsswgl/CiticGmApi', '_blank')">ğŸ™ GitHub ä»“åº“</button>
            </div>

            <h3 style="margin: 30px 0 15px 0;">ğŸ”Œ API ç«¯ç‚¹åˆ—è¡¨</h3>
            <div style="background:#f8f9fa; padding:20px; border-radius:6px;">
                <p><strong>åŸºç¡€URL:</strong> <code>https://citic.qsgl.net/api/Crypto</code></p>
                <ul style="margin-top:15px; line-height:2;">
                    <li><code>GET  /sm2/keypair</code> - ç”ŸæˆSM2å¯†é’¥å¯¹</li>
                    <li><code>POST /sm2/encrypt</code> - SM2åŠ å¯†</li>
                    <li><code>POST /sm2/decrypt</code> - SM2è§£å¯†</li>
                    <li><code>POST /sm2/sign</code> - SM2ç­¾å</li>
                    <li><code>POST /sm2/verify</code> - SM2éªŒç­¾</li>
                    <li><code>GET  /sm4/generate-key</code> - ç”ŸæˆSM4å¯†é’¥</li>
                    <li><code>POST /sm4/encrypt</code> - SM4åŠ å¯†</li>
                    <li><code>POST /sm4/decrypt</code> - SM4è§£å¯†</li>
                </ul>
            </div>

            <h3 style="margin: 30px 0 15px 0;">ğŸ’¡ å…³é”®å‚æ•°è¯´æ˜</h3>
            <div style="background:#f8f9fa; padding:20px; border-radius:6px;">
                <h4>SM4 åŠ å¯†/è§£å¯†</h4>
                <p><strong>key:</strong> 32ä½Hexå­—ç¬¦ä¸² (16å­—èŠ‚)</p>
                <p><strong>iv:</strong> 32ä½Hexå­—ç¬¦ä¸²ï¼Œæµ‹è¯•ä½¿ç”¨ "30303030..." (16ä¸ª'0'çš„ASCIIç )</p>
                
                <h4 style="margin-top:15px">SM2 åŠ å¯†/è§£å¯†</h4>
                <p><strong>publicKey:</strong> X509 Base64æ ¼å¼æˆ–Hexæ ¼å¼</p>
                <p><strong>privateKey:</strong> æ”¯æŒPEM/Base64/Hexä¸‰ç§æ ¼å¼</p>
                <p><strong>password:</strong> ç§é’¥å¯†ç ï¼ˆå¯é€‰ï¼‰</p>
                
                <h4 style="margin-top:15px">å­—æ®µåå…¼å®¹æ€§</h4>
                <p>âœ… æ”¯æŒ <code>plaintext</code> æˆ– <code>data</code></p>
                <p>âœ… æ”¯æŒ <code>privateKey</code> æˆ– <code>privateKeyHex</code></p>
                <p>âœ… æ”¯æŒ <code>publicKey</code> æˆ– <code>publicKeyHex</code></p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://citic.qsgl.net/api/Crypto';
        let workflowData = {};
        let stepData = {};

        // ========== Tab åˆ‡æ¢ ==========
        function switchTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            tabs[index].classList.add('active');
            contents[index].classList.add('active');
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function log(message, type = 'info') {
            const logDiv = document.getElementById('workflowLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function showResult(elementId, success, title, data = null) {
            const resultDiv = document.getElementById(elementId);
            const className = success ? 'success' : 'error';
            const icon = success ? 'âœ…' : 'âŒ';
            
            let html = `<div class="result ${className}">`;
            html += `<h3>${icon} ${title}</h3>`;
            if (data) {
                const jsonStr = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                html += `<button class="copy-btn" onclick="copyToClipboard(\`${jsonStr.replace(/`/g, '\\`')}\`)">å¤åˆ¶</button>`;
                html += `<pre>${jsonStr}</pre>`;
            }
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        function updateProgress(percent) {
            document.getElementById('workflowProgress').style.width = percent + '%';
        }

        // ========== å¯†é’¥ç®¡ç† ==========
        function saveKeys() {
            const keys = {
                citicPublicKey: document.getElementById('citicPublicKey').value,
                merchantPrivateKey: document.getElementById('merchantPrivateKey').value,
                merchantPassword: document.getElementById('merchantPassword').value
            };
            localStorage.setItem('citicKeys', JSON.stringify(keys));
            showResult('keyResult', true, 'å¯†é’¥ä¿å­˜æˆåŠŸ', 'å¯†é’¥å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨');
        }

        function loadKeys() {
            const keys = JSON.parse(localStorage.getItem('citicKeys') || '{}');
            document.getElementById('citicPublicKey').value = keys.citicPublicKey || '';
            document.getElementById('merchantPrivateKey').value = keys.merchantPrivateKey || '';
            document.getElementById('merchantPassword').value = keys.merchantPassword || '';
            showResult('keyResult', true, 'å¯†é’¥åŠ è½½æˆåŠŸ', 'å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½å¯†é’¥');
        }

        function loadDefaultKeys() {
            // ä» WechatPayTestView.swift ä¸­æå–çš„é»˜è®¤å¯†é’¥
            document.getElementById('citicPublicKey').value = 'MIIB2jCCAYWgAwIBAgIGBzRJk5c4MAwGCCqBHM9VAYN1BQAwKzENMAsGA1UEAwwEVFBDRzENMAsGA1UECwwETEFBUzELMAkGA1UEBhMCQ04wHhcNMjIwOTA5MDYyMjM3WhcNMjUwOTA4MDYyMjM3WjArMQ0wCwYDVQQDDARUUENHMQ0wCwYDVQQLDARMQUFTMQswCQYDVQQGEwJDTjBZMBMGByqGSM49AgEGCCqBHM9VAYItA0IABMSXc2/d55C1tYpc+Y2hmcQz8WzPAqQEdodSmKqvwYa9/mhrh+TxX8o07U8A3LMKOforTpB9bOhXfV8CN3bGhWGjgZIwgY8wXgYDVR0jBFcwVYAUNk92kc/MqLujwQmiSRBTa6oIdFGhOqQ4MDYxCzAJBgNVBAMMAkFVMRYwFAYDVQQKDA1Cb3VuY3kgQ2FzdGxlMQ8wDQYDVQQLDAZUZXN0IDKCAQIwDgYDVR0PAQH/BAQDAgKEMB0GA1UdDgQWBBQ2T3aRz8you6PBCaJJEFNrqgh0UTAMBggqgRzPVQGDdQUAA0EAnIy+kcXaRP3+Qv8yYRWdK1JsVmA/W/+9PkmGOsrnPDzc5sia22P9ZfnYbFIEIrBbPohHE4Cyf6xduYQ+o/MgCw==';
            document.getElementById('merchantPrivateKey').value = 'A1NNMt82STbFA2rh0e+9nHbZIvVCMahzGap8z3dEi7B8UUjdbsGJgmLqseO1x50cLmGOBB3Gpypuci2ArEP3VjLsppVMHdA/22j9buxiXi0QFVRIOz9MzqlNuzkCLCngxxr/yXPkhiAdm1leMlkfNW1Ab/g=';
            document.getElementById('merchantPassword').value = 'A1SttKLQG3bIh5Bk';
            showResult('keyResult', true, 'å·²åŠ è½½é»˜è®¤æµ‹è¯•å¯†é’¥', 'è­¦å‘Šï¼šè¿™äº›æ˜¯æµ‹è¯•å¯†é’¥ï¼Œè¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨');
        }

        function clearKeys() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¯†é’¥é…ç½®å—ï¼Ÿ')) {
                document.getElementById('citicPublicKey').value = '';
                document.getElementById('merchantPrivateKey').value = '';
                document.getElementById('merchantPassword').value = '';
                localStorage.removeItem('citicKeys');
                showResult('keyResult', true, 'å¯†é’¥å·²æ¸…ç©º');
            }
        }

        // ========== å®Œæ•´æµç¨‹æµ‹è¯• ==========
        async function runFullWorkflow() {
            clearWorkflowLog();
            updateProgress(0);
            log('========== å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯• ==========', 'info');
            
            try {
                // æ­¥éª¤1: ç”ŸæˆSM4å¯†é’¥
                updateProgress(10);
                log('æ­¥éª¤1: ç”ŸæˆSM4å¯†é’¥...', 'info');
                const sm4Key = generateSM4KeyHex();
                workflowData.sm4Key = sm4Key;
                log(`âœ“ SM4å¯†é’¥: ${sm4Key}`, 'success');

                // æ­¥éª¤2: å‡†å¤‡ä¸šåŠ¡å‚æ•°
                updateProgress(20);
                log('æ­¥éª¤2: å‡†å¤‡ä¸šåŠ¡å‚æ•°...', 'info');
                let bizParams = document.getElementById('bizParams').value;
                // æ›¿æ¢æ—¶é—´æˆ³å ä½ç¬¦
                bizParams = bizParams.replace('${timestamp}', Date.now());
                const bizJson = JSON.parse(bizParams);
                log(`âœ“ ä¸šåŠ¡å‚æ•°: ${JSON.stringify(bizJson).substring(0, 100)}...`, 'success');

                // æ­¥éª¤3: SM4åŠ å¯†ä¸šåŠ¡æŠ¥æ–‡
                updateProgress(30);
                log('æ­¥éª¤3: SM4åŠ å¯†ä¸šåŠ¡æŠ¥æ–‡...', 'info');
                const encryptedBody = await callSM4Encrypt(JSON.stringify(bizJson), sm4Key);
                workflowData.encryptedBody = encryptedBody;
                log(`âœ“ åŠ å¯†æŠ¥æ–‡ (å‰50å­—ç¬¦): ${encryptedBody.substring(0, 50)}...`, 'success');

                // æ­¥éª¤4: SM2åŠ å¯†SM4å¯†é’¥
                updateProgress(50);
                log('æ­¥éª¤4: SM2åŠ å¯†SM4å¯†é’¥(ç”ŸæˆencryptSessionKey)...', 'info');
                const sessionKey = await callSM2EncryptKey(sm4Key);
                workflowData.sessionKey = sessionKey;
                log(`âœ“ encryptSessionKey (å‰50å­—ç¬¦): ${sessionKey.substring(0, 50)}...`, 'success');

                // æ­¥éª¤5: SM2ç­¾ååŸå§‹ä¸šåŠ¡æŠ¥æ–‡
                updateProgress(70);
                log('æ­¥éª¤5: SM2ç­¾ååŸå§‹ä¸šåŠ¡æŠ¥æ–‡...', 'info');
                const signature = await callSM2Sign(JSON.stringify(bizJson));
                workflowData.signature = signature;
                log(`âœ“ ç­¾å (å‰50å­—ç¬¦): ${signature.substring(0, 50)}...`, 'success');

                // æ­¥éª¤6: ç»„è£…è¯·æ±‚
                updateProgress(80);
                log('æ­¥éª¤6: ç»„è£…è¯·æ±‚å‚æ•°...', 'info');
                const requestData = {
                    headers: {
                        merchantNo: bizJson.mchId,
                        tranCode: 'QrLaasApiService:weixinApppay',
                        serialNo: Date.now() + Math.floor(Math.random() * 10000),
                        tranTmpt: new Date().toISOString(),
                        version: '1.0',
                        signature: signature,
                        encryptSessionKey: sessionKey
                    },
                    body: {
                        encData: encryptedBody
                    }
                };
                log(`âœ“ è¯·æ±‚å·²ç»„è£…å®Œæˆ`, 'success');
                log(`å®Œæ•´è¯·æ±‚æ•°æ®:\n${JSON.stringify(requestData, null, 2)}`, 'info');

                updateProgress(100);
                log('========== æµç¨‹æµ‹è¯•å®Œæˆ ==========', 'success');
                log('æç¤º: å®é™…å‘é€è¯·æ±‚éœ€è¦é…ç½®ä¸­ä¿¡é“¶è¡Œç½‘å…³åœ°å€', 'warning');
                
                showResult('workflowLog', true, 'æµç¨‹æµ‹è¯•å®Œæˆ', requestData);

            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                updateProgress(0);
                showResult('workflowLog', false, 'æµç¨‹æµ‹è¯•å¤±è´¥', error.message);
            }
        }

        function clearWorkflowLog() {
            document.getElementById('workflowLog').innerHTML = '';
        }

        function fillTestData() {
            // è‡ªåŠ¨å¡«å……æµ‹è¯•æ•°æ®å¹¶åŠ è½½é»˜è®¤å¯†é’¥
            loadDefaultKeys();
            alert('å·²å¡«å……æµ‹è¯•æ•°æ®å’Œé»˜è®¤å¯†é’¥ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œæµ‹è¯•');
        }

        // ========== å•æ­¥æµ‹è¯•å‡½æ•° ==========
        function testGenerateSM4Key() {
            const key = generateSM4KeyHex();
            document.getElementById('sm4KeyStep').value = key;
            stepData.sm4Key = key;
            showResult('stepResult', true, 'SM4å¯†é’¥ç”ŸæˆæˆåŠŸ', key);
        }

        async function testSM4Encrypt() {
            try {
                const plaintext = document.getElementById('plainTextStep').value;
                const sm4Key = document.getElementById('sm4KeyStep').value;
                if (!plaintext || !sm4Key) {
                    throw new Error('è¯·å…ˆè¾“å…¥æ˜æ–‡å’ŒSM4å¯†é’¥');
                }
                const ciphertext = await callSM4Encrypt(plaintext, sm4Key);
                document.getElementById('sm4CipherStep').value = ciphertext;
                stepData.ciphertext = ciphertext;
                showResult('stepResult', true, 'SM4åŠ å¯†æˆåŠŸ', ciphertext);
            } catch (error) {
                showResult('stepResult', false, 'SM4åŠ å¯†å¤±è´¥', error.message);
            }
        }

        async function testSM2EncryptKey() {
            try {
                const sm4Key = document.getElementById('sm4KeyStep').value;
                if (!sm4Key) {
                    throw new Error('è¯·å…ˆç”ŸæˆSM4å¯†é’¥');
                }
                const sessionKey = await callSM2EncryptKey(sm4Key);
                document.getElementById('sessionKeyStep').value = sessionKey;
                stepData.sessionKey = sessionKey;
                showResult('stepResult', true, 'SM2åŠ å¯†å¯†é’¥æˆåŠŸ', sessionKey);
            } catch (error) {
                showResult('stepResult', false, 'SM2åŠ å¯†å¤±è´¥', error.message);
            }
        }

        async function testSM2SignStep() {
            try {
                const plaintext = document.getElementById('plainTextStep').value;
                if (!plaintext) {
                    throw new Error('è¯·å…ˆè¾“å…¥è¦ç­¾åçš„æ˜æ–‡');
                }
                const signature = await callSM2Sign(plaintext);
                document.getElementById('signatureStep').value = signature;
                stepData.signature = signature;
                showResult('stepResult', true, 'SM2ç­¾åæˆåŠŸ', signature);
            } catch (error) {
                showResult('stepResult', false, 'SM2ç­¾åå¤±è´¥', error.message);
            }
        }

        async function testSM2DecryptKey() {
            try {
                const encryptedKey = document.getElementById('encryptedKeyInput').value;
                if (!encryptedKey) {
                    throw new Error('è¯·è¾“å…¥åŠ å¯†çš„SessionKey');
                }
                const decryptedKey = await callSM2Decrypt(encryptedKey);
                document.getElementById('decryptedKeyStep').value = decryptedKey;
                stepData.decryptedSm4Key = decryptedKey;
                showResult('stepResult', true, 'SM2è§£å¯†å¯†é’¥æˆåŠŸ', decryptedKey);
            } catch (error) {
                showResult('stepResult', false, 'SM2è§£å¯†å¤±è´¥', error.message);
            }
        }

        async function testSM4DecryptStep() {
            try {
                const ciphertext = document.getElementById('cipherTextDecryptStep').value;
                const sm4Key = document.getElementById('decryptedKeyStep').value || document.getElementById('sm4KeyStep').value;
                if (!ciphertext || !sm4Key) {
                    throw new Error('è¯·è¾“å…¥å¯†æ–‡å’ŒSM4å¯†é’¥');
                }
                const plaintext = await callSM4Decrypt(ciphertext, sm4Key);
                document.getElementById('decryptedTextStep').value = plaintext;
                showResult('stepResult', true, 'SM4è§£å¯†æˆåŠŸ', plaintext);
            } catch (error) {
                showResult('stepResult', false, 'SM4è§£å¯†å¤±è´¥', error.message);
            }
        }

        // ========== APIè°ƒç”¨å‡½æ•° ==========
        function generateSM4KeyHex() {
            // ç”Ÿæˆ32ä½Hexå­—ç¬¦ä¸² (16å­—èŠ‚)
            return Array.from({length: 16}, () => 
                Math.floor(Math.random() * 256).toString(16).padStart(2, '0')
            ).join('').toUpperCase();
        }

        async function callSM4Encrypt(plaintext, key) {
            const iv = '30'.repeat(16); // IV: 16ä¸ª'0'çš„ASCIIç 
            const response = await fetch(`${API_BASE}/sm4/encrypt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaintext, key, iv })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data.ciphertext;
        }

        async function callSM4Decrypt(ciphertext, key) {
            const iv = '30'.repeat(16);
            const response = await fetch(`${API_BASE}/sm4/decrypt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ciphertext, key, iv })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data.plaintext;
        }

        async function callSM2EncryptKey(sm4KeyHex) {
            const publicKey = document.getElementById('citicPublicKey').value;
            if (!publicKey) throw new Error('è¯·å…ˆé…ç½®ä¸­ä¿¡å…¬é’¥');
            
            const response = await fetch(`${API_BASE}/sm2/encrypt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    plaintext: sm4KeyHex, 
                    publicKey: publicKey,
                    isBase64Input: false 
                })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data.ciphertext;
        }

        async function callSM2Sign(plaintext) {
            const privateKey = document.getElementById('merchantPrivateKey').value;
            if (!privateKey) throw new Error('è¯·å…ˆé…ç½®å•†æˆ·ç§é’¥');
            
            const response = await fetch(`${API_BASE}/sm2/sign`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ plaintext, privateKey })
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data.signature;
        }

        async function callSM2Decrypt(ciphertext) {
            const privateKey = document.getElementById('merchantPrivateKey').value;
            const password = document.getElementById('merchantPassword').value;
            if (!privateKey) throw new Error('è¯·å…ˆé…ç½®å•†æˆ·ç§é’¥');
            
            const body = { ciphertext, privateKey };
            if (password) body.password = password;
            
            const response = await fetch(`${API_BASE}/sm2/decrypt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const result = await response.json();
            if (!result.success) throw new Error(result.message);
            return result.data.plaintext;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å¯†é’¥
        window.onload = function() {
            const savedKeys = localStorage.getItem('citicKeys');
            if (savedKeys) {
                loadKeys();
            }
        };
    </script>
</body>
</html>
