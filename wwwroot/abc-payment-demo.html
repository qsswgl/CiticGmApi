<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†œè¡Œæ”¯ä»˜ - é¡µé¢æ”¯ä»˜æ¼”ç¤º</title>
    <style>
        * {
                    <div class="form-group">
                <label for="payTypeID">äº¤æ˜“ç±»å‹ *</label>
                <select id="payTypeID" name="payTypeID" required>
                    <option value="ImmediatePay" selected>æ™®é€šæ”¯ä»˜</option>
                    <option value="DividedPay">åˆ†æœŸæ”¯ä»˜</option>
                    <option value="PreAuthPay">é¢„æˆæƒæ”¯ä»˜</option>
                </select>
                <small>é€‰æ‹©æ”¯ä»˜äº¤æ˜“ç±»å‹</small>
            </div>

            <div class="form-group">
                <label for="orderDesc">è®¢å•æè¿° *</label>
                <input type="text" id="orderDesc" name="orderDesc" value="æµ‹è¯•è®¢å• - PaymentType=A" required>
                <small>è®¢å•çš„ç®€è¦æè¿°</small>
            </div>

            <div class="form-group">
                <label for="notifyUrl">å¼‚æ­¥é€šçŸ¥åœ°å€ *</label>
                <input type="url" id="notifyUrl" name="notifyUrl" value="https://payment.qsgl.net/api/payment/abc/notify" required>
                <small>æ”¯ä»˜ç»“æœå¼‚æ­¥å›è°ƒåœ°å€</small>
            </div> 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            display: block;
            color: #999;
            margin-top: 5px;
            font-size: 12px;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .result pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            margin-top: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .info-box h4 {
            color: #1976D2;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box p {
            color: #555;
            font-size: 13px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ å†œä¸šé“¶è¡Œæ”¯ä»˜</h1>
            <p>PayReq é¡µé¢æ”¯ä»˜æ¥å£æ¼”ç¤º</p>
        </div>

        <div class="info-box">
            <h4>ğŸ“ æ¥å£è¯´æ˜</h4>
            <p>
                æœåŠ¡å™¨åœ°å€: <strong>https://payment.qsgl.net</strong><br>
                æ¥å£è·¯å¾„: <strong>/api/payment/abc/pagepay</strong><br>
                æµ‹è¯•å•†æˆ·: <strong>103881636900016</strong>
            </p>
        </div>

        <form id="paymentForm">
            <div class="form-group">
                <label for="merchantId">å•†æˆ·å· *</label>
                <input type="text" id="merchantId" name="merchantId" value="103881636900016" required>
                <small>å†œè¡Œåˆ†é…çš„å•†æˆ·å·</small>
            </div>

            <div class="form-group">
                <label for="amount">æ”¯ä»˜é‡‘é¢ (å…ƒ) *</label>
                <input type="number" id="amount" name="amount" value="0.01" step="0.01" min="0.01" required>
                <small>æœ€å°é‡‘é¢ 0.01 å…ƒ</small>
            </div>

            <div class="form-group">
                <label for="payTypeID">äº¤æ˜“ç±»å‹ *</label>
                <select id="payTypeID" name="payTypeID" required>
                    <option value="ImmediatePay">æ™®é€šæ”¯ä»˜</option>
                    <option value="DividedPay">åˆ†æœŸæ”¯ä»˜</option>
                    <option value="PreAuthPay" selected>é¢„æˆæƒæ”¯ä»˜</option>
                </select>
                <small>é€‰æ‹©æ”¯ä»˜äº¤æ˜“ç±»å‹</small>
            </div>

            <div class="form-group">
                <label for="orderDesc">è®¢å•æè¿° *</label>
                <input type="text" id="orderDesc" name="orderDesc" value="æµ‹è¯•è®¢å• - PaymentType=A" required>
                <small>è®¢å•çš„ç®€è¦æè¿°</small>
            </div>

            <div class="form-group">
                <label for="notifyUrl">å¼‚æ­¥é€šçŸ¥åœ°å€ *</label>
                <input type="url" id="notifyUrl" name="notifyUrl" value="https://payment.qsgl.net/api/payment/abc/notify" required>
                <small>æ”¯ä»˜ç»“æœå¼‚æ­¥å›è°ƒåœ°å€</small>
            </div>

            <div class="form-group">
                <label for="merchantSuccessUrl">æ”¯ä»˜æˆåŠŸè·³è½¬åœ°å€</label>
                <input type="url" id="merchantSuccessUrl" name="merchantSuccessUrl" value="https://payment.qsgl.net/payment/success" placeholder="å¯é€‰">
                <small>æ”¯ä»˜æˆåŠŸåè·³è½¬çš„é¡µé¢</small>
            </div>

            <div class="form-group">
                <label for="merchantErrorUrl">æ”¯ä»˜å¤±è´¥è·³è½¬åœ°å€</label>
                <input type="url" id="merchantErrorUrl" name="merchantErrorUrl" value="https://payment.qsgl.net/payment/error" placeholder="å¯é€‰">
                <small>æ”¯ä»˜å¤±è´¥åè·³è½¬çš„é¡µé¢</small>
            </div>

            <button type="submit" class="btn" id="submitBtn">
                ğŸš€ å‘èµ·æ”¯ä»˜
            </button>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†æ”¯ä»˜è¯·æ±‚...</p>
        </div>

        <div class="result" id="result">
            <h3 id="resultTitle"></h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // é…ç½®
        const API_CONFIG = {
            // ç”Ÿäº§ç¯å¢ƒ
            baseUrl: 'https://payment.qsgl.net',
            endpoint: '/api/payment/abc/pagepay',
            
            // æœ¬åœ°æµ‹è¯•ç¯å¢ƒ (å–æ¶ˆæ³¨é‡Šä»¥ä½¿ç”¨æœ¬åœ°æµ‹è¯•)
            // baseUrl: 'http://localhost:5000',
            // endpoint: '/api/payment/abc/pagepay'
        };

        // è·å–è¡¨å•å…ƒç´ 
        const form = document.getElementById('paymentForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const resultTitle = document.getElementById('resultTitle');
        const resultContent = document.getElementById('resultContent');

        // ç”Ÿæˆè®¢å•å· (æ ¼å¼: TEST + æ—¶é—´æˆ³)
        function generateOrderNo() {
            return 'TEST' + Date.now();
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(success, title, content) {
            result.style.display = 'block';
            result.className = 'result ' + (success ? 'success' : 'error');
            resultTitle.textContent = title;
            resultContent.innerHTML = content;
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // éšè—ç»“æœ
        function hideResult() {
            result.style.display = 'none';
        }

        // è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'å¤„ç†ä¸­...';
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loading.style.display = 'block';
            hideResult();

            try {
                // è·å–è¡¨å•æ•°æ®
                const formData = new FormData(form);
                
                // ç”Ÿæˆå”¯ä¸€è®¢å•å·
                const orderNo = generateOrderNo();
                
                // æ„å»ºè¯·æ±‚æ•°æ®
                const requestData = {
                    merchantId: formData.get('merchantId'),
                    amount: parseFloat(formData.get('amount')),
                    orderNo: orderNo,
                    orderDesc: formData.get('orderDesc'),
                    payTypeID: formData.get('payTypeID'),
                    notifyUrl: formData.get('notifyUrl'),
                    merchantSuccessUrl: formData.get('merchantSuccessUrl') || undefined,
                    merchantErrorUrl: formData.get('merchantErrorUrl') || undefined
                };

                console.log('ğŸ“¤ å‘é€æ”¯ä»˜è¯·æ±‚:', requestData);

                // å‘é€è¯·æ±‚
                const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);

                // è§£æå“åº”
                const responseData = await response.json();
                console.log('ğŸ“¥ å“åº”æ•°æ®:', responseData);

                // éšè—åŠ è½½åŠ¨ç”»
                loading.style.display = 'none';

                // åˆ¤æ–­æ˜¯å¦æˆåŠŸ
                if (response.ok && responseData.isSuccess && responseData.paymentURL) {
                    // æ”¯ä»˜è¯·æ±‚æˆåŠŸ
                    const successHtml = `
                        <p><strong>è®¢å•å·:</strong> ${responseData.orderNo}</p>
                        <p><strong>çŠ¶æ€ç :</strong> ${responseData.errorCode}</p>
                        <p><strong>æ¶ˆæ¯:</strong> ${responseData.message}</p>
                        <p style="margin-top: 15px;">
                            <strong>æ”¯ä»˜é“¾æ¥å·²ç”Ÿæˆ,å³å°†è·³è½¬...</strong>
                        </p>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre>
                    `;
                    
                    showResult(true, 'âœ… æ”¯ä»˜è¯·æ±‚æˆåŠŸ', successHtml);

                    // 3ç§’åè·³è½¬åˆ°å†œè¡Œæ”¯ä»˜é¡µé¢
                    setTimeout(() => {
                        console.log('ğŸ”— è·³è½¬åˆ°æ”¯ä»˜é¡µé¢:', responseData.paymentURL);
                        window.location.href = responseData.paymentURL;
                    }, 3000);

                } else {
                    // æ”¯ä»˜è¯·æ±‚å¤±è´¥
                    const errorHtml = `
                        <p><strong>é”™è¯¯ç :</strong> ${responseData.errorCode || 'N/A'}</p>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${responseData.message || 'æœªçŸ¥é”™è¯¯'}</p>
                        <pre>${JSON.stringify(responseData, null, 2)}</pre>
                    `;
                    
                    showResult(false, 'âŒ æ”¯ä»˜è¯·æ±‚å¤±è´¥', errorHtml);
                }

            } catch (error) {
                console.error('âŒ è¯·æ±‚å¼‚å¸¸:', error);
                
                loading.style.display = 'none';
                
                const errorHtml = `
                    <p><strong>å¼‚å¸¸ç±»å‹:</strong> ${error.name}</p>
                    <p><strong>å¼‚å¸¸ä¿¡æ¯:</strong> ${error.message}</p>
                    <p style="margin-top: 10px;">
                        <strong>å¯èƒ½åŸå› :</strong><br>
                        1. ç½‘ç»œè¿æ¥å¤±è´¥<br>
                        2. æœåŠ¡å™¨æœªå“åº”<br>
                        3. CORSè·¨åŸŸé—®é¢˜<br>
                        4. æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
                    </p>
                    <pre>${error.stack || ''}</pre>
                `;
                
                showResult(false, 'âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥', errorHtml);
            } finally {
                // æ¢å¤æäº¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ å‘èµ·æ”¯ä»˜';
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            console.log('âœ… é¡µé¢åŠ è½½å®Œæˆ');
            console.log('ğŸ”§ APIé…ç½®:', API_CONFIG);
            console.log('ğŸ’¡ æç¤º: æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12) æŸ¥çœ‹è¯¦ç»†æ—¥å¿—');
        });
    </script>
</body>
</html>
