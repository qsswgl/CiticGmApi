# æ·»åŠ å†œè¡Œæ ¹è¯ä¹¦æµ‹è¯•æŠ¥å‘Š

## ğŸ“… æµ‹è¯•æ—¥æœŸ
2026å¹´1æœˆ21æ—¥ 14:59

---

## ğŸ”§ å·²å®Œæˆçš„ä¿®æ”¹

### 1. å¤åˆ¶å†œè¡Œæ ¹è¯ä¹¦
```
æºæ–‡ä»¶: K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\TrustPay.cer
ç›®æ ‡: K:\payment\AbcPaymentGateway\cert\prod\TrustPay.cer
çŠ¶æ€: âœ… å·²å¤åˆ¶
```

### 2. é…ç½®æ–‡ä»¶å·²å°±ç»ª
`appsettings.Development.json` å·²æœ‰é…ç½®:
```json
"TrustPayCertPath": "K:/payment/AbcPaymentGateway/cert/prod/TrustPay.cer"
```

### 3. ä¿®æ”¹ Program.cs

**ä¿®æ”¹å‰** (åªæœ‰å•†æˆ·è¯ä¹¦):
```csharp
if (certificate != null)
{
    handler.ClientCertificates.Add(certificate);
    // ...
}
```

**ä¿®æ”¹å** (å†œè¡Œæ ¹è¯ä¹¦ + å•†æˆ·è¯ä¹¦):
```csharp
// æ·»åŠ å†œè¡Œæ ¹è¯ä¹¦ï¼ˆTrustPayè¯ä¹¦ï¼‰- å…³é”®ï¼Demoæœ‰é…ç½®ï¼Œæˆ‘ä»¬ä¹‹å‰æ²¡æœ‰
if (trustPayCertificate != null)
{
    handler.ClientCertificates.Add(trustPayCertificate);
    logger.LogInformation("âœ… HttpClient å·²é…ç½®å†œè¡Œæ ¹è¯ä¹¦ (TrustPay): {Subject}", trustPayCertificate.Subject);
}
else
{
    logger.LogWarning("âš ï¸ å†œè¡Œæ ¹è¯ä¹¦ (TrustPay) æœªåŠ è½½ï¼Œå¯èƒ½å¯¼è‡´2302è¯ä¹¦é”™è¯¯");
}

// æ·»åŠ å•†æˆ·è¯ä¹¦
if (merchantCertificate != null)
{
    handler.ClientCertificates.Add(merchantCertificate);
    // ...
}

logger.LogInformation("ğŸ“‹ å®¢æˆ·ç«¯è¯ä¹¦é…ç½®å®Œæˆ - å…± {Count} ä¸ªè¯ä¹¦", handler.ClientCertificates.Count);
```

---

## âœ… ç¼–è¯‘ç»“æœ

```
AbcPaymentGateway net10.0 æˆåŠŸï¼Œå‡ºç° 22 è­¦å‘Š (6.5 ç§’)
åœ¨ 7.9 ç§’å†…ç”Ÿæˆ æˆåŠŸï¼Œå‡ºç° 23 è­¦å‘Š
```

**çŠ¶æ€**: âœ… ç¼–è¯‘æˆåŠŸ

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### APIå¯åŠ¨
```
APIè¿›ç¨‹ID: 32832
å¯åŠ¨æ—¶é—´: 2026/1/21 14:59:07
å¥åº·æ£€æŸ¥: 200 OK âœ…
```

### æ”¯ä»˜æµ‹è¯•
```
æµ‹è¯•æ—¶é—´: 2026/1/21 14:59:35
è®¢å•å·: TEST1768978774948
```

**å“åº”**:
```json
{
  "isSuccess": false,
  "orderNo": "TEST1768978774948",
  "transactionId": "",
  "paymentURL": "",
  "amount": 2.00,
  "status": "FAILED",
  "message": "å•†æˆ·æœåŠ¡å™¨è¯ä¹¦é…ç½®æœ‰è¯¯ï¼Œè¯·ç™»å½•å•†æˆ·æœåŠ¡ç³»ç»Ÿæ£€æŸ¥å•†æˆ·è¯ä¹¦ï¼Œ103881636900016 (2302)",
  "expireTime": "2026-01-21T15:29:35.4289153+08:00",
  "errorCode": "2302",
  "returnCode": "2302"
}
```

**ç»“æœ**: âŒ ä»ç„¶è¿”å› 2302 é”™è¯¯

---

## ğŸ¤” åˆ†æ

### å·²å°è¯•çš„æ–¹æ¡ˆ
1. âœ… æ·»åŠ å®¢æˆ·ç«¯è¯ä¹¦ - å·²é…ç½®
2. âœ… ä¿®æ”¹PaymentTypeä¸º"1" - å·²å®Œæˆ
3. âœ… æ·»åŠ å†œè¡Œæ ¹è¯ä¹¦ - **åˆšåˆšå®Œæˆï¼Œä½†ä»å¤±è´¥**

### ä¸ºä»€ä¹ˆä»ç„¶å¤±è´¥ï¼Ÿ

#### å¯èƒ½åŸå› 1: è¯ä¹¦é¡ºåºæˆ–åŠ è½½æ–¹å¼

**å½“å‰ä»£ç **:
```csharp
handler.ClientCertificates.Add(trustPayCertificate);  // å…ˆæ·»åŠ æ ¹è¯ä¹¦
handler.ClientCertificates.Add(merchantCertificate);  // åæ·»åŠ å•†æˆ·è¯ä¹¦
```

**å¯èƒ½éœ€è¦**:
- åè½¬é¡ºåºï¼Ÿï¼ˆå…ˆå•†æˆ·åæ ¹è¯ä¹¦ï¼‰
- æˆ–åªå‘é€å•†æˆ·è¯ä¹¦ï¼Œæ ¹è¯ä¹¦ç”¨äºéªŒè¯ï¼Ÿ
- æˆ–æ ¹è¯ä¹¦ä¸åº”è¯¥æ·»åŠ åˆ°ClientCertificatesï¼Ÿ

#### å¯èƒ½åŸå› 2: è¯ä¹¦åŠ è½½æ ‡å¿—

**å•†æˆ·è¯ä¹¦åŠ è½½**:
```csharp
new X509Certificate2(
    fullPath,
    certPassword,
    X509KeyStorageFlags.Exportable | X509KeyStorageFlags.PersistKeySet
);
```

**æ ¹è¯ä¹¦åŠ è½½**:
```csharp
new X509Certificate2(fullPath);  // æ²¡æœ‰å¯†ç ï¼Œæ²¡æœ‰æ ‡å¿—
```

#### å¯èƒ½åŸå› 3: æ ¹è¯ä¹¦ç”¨é€”

TrustPay.cer å¯èƒ½ä¸åº”è¯¥ä½œä¸ºå®¢æˆ·ç«¯è¯ä¹¦å‘é€ï¼Œè€Œåº”è¯¥ï¼š
- ç”¨äºéªŒè¯æœåŠ¡å™¨è¯ä¹¦
- æ·»åŠ åˆ°å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„
- ç”¨äºæ„å»ºè¯ä¹¦é“¾

#### å¯èƒ½åŸå› 4: å†œè¡ŒæœåŠ¡å™¨ç«¯é…ç½®

Demoæ—©ä¸ŠæˆåŠŸï¼Œç°åœ¨å¤±è´¥ï¼Œæ—¶é—´å·®çº¦6å°æ—¶ï¼š
```
DemoæˆåŠŸ: 2026-01-21 09:20
æˆ‘ä»¬æµ‹è¯•: 2026-01-21 14:59
```

å¯èƒ½å†œè¡Œåœ¨æ­¤æœŸé—´ä¿®æ”¹äº†é…ç½®ã€‚

---

## ğŸ”¬ éœ€è¦è¿›ä¸€æ­¥éªŒè¯

### éªŒè¯1: æ£€æŸ¥å¯åŠ¨æ—¥å¿—

éœ€è¦æŸ¥çœ‹APIå¯åŠ¨æ—¶çš„æ—¥å¿—ï¼Œç¡®è®¤ï¼š
- âœ… å†œè¡Œæ ¹è¯ä¹¦æ˜¯å¦æˆåŠŸåŠ è½½
- âœ… HttpClientæ˜¯å¦æ˜¾ç¤º"å…±2ä¸ªè¯ä¹¦"
- â“ æ˜¯å¦æœ‰ä»»ä½•è¯ä¹¦ç›¸å…³çš„è­¦å‘Šæˆ–é”™è¯¯

### éªŒè¯2: è¯ä¹¦é“¾æ„å»º

```csharp
// æ£€æŸ¥å•†æˆ·è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´
var chain = new X509Chain();
chain.ChainPolicy.ExtraStore.Add(trustPayCertificate);  // æ·»åŠ æ ¹è¯ä¹¦åˆ°é“¾å­˜å‚¨
bool isValid = chain.Build(merchantCertificate);
```

### éªŒè¯3: Demoæ˜¯å¦è¿˜èƒ½æˆåŠŸ

è¿è¡ŒDemoï¼Œçœ‹æ˜¯å¦è¿˜èƒ½ç”ŸæˆPaymentURLï¼š
- å¦‚æœDemoä¹Ÿå¤±è´¥ â†’ å†œè¡Œç«¯æœ‰å˜æ›´
- å¦‚æœDemoè¿˜æˆåŠŸ â†’ æˆ‘ä»¬çš„å®ç°è¿˜æœ‰é—®é¢˜

### éªŒè¯4: æŠ“åŒ…å¯¹æ¯”

ä½¿ç”¨Wiresharkå¯¹æ¯”ï¼š
- DemoæˆåŠŸæ—¶çš„TLSæ¡æ‰‹
- æˆ‘ä»¬å¤±è´¥æ—¶çš„TLSæ¡æ‰‹
- é‡ç‚¹çœ‹Client Certificateæ¶ˆæ¯

---

## ğŸ“‹ Demoé…ç½®å¯¹æ¯”

### Demoçš„è¯ä¹¦é…ç½® (Web.config)

```xml
<!-- å†œè¡Œç”Ÿäº§ç¯å¢ƒè¯ä¹¦ -->
<add key="TrustPayCertFile" value="K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\TrustPay.cer"/>
<!-- å†œè¡Œæ ¹è¯ä¹¦ -->
<add key="TrustStoreFile" value="K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\abc.truststore"/>
<add key="TrustStorePassword" value="changeit"/>
```

**å…³é”®å‘ç°**:
- `TrustPayCertFile` = TrustPay.cer âœ… æˆ‘ä»¬å·²æ·»åŠ 
- `TrustStoreFile` = **abc.truststore** â“ æˆ‘ä»¬æ²¡æœ‰è¿™ä¸ªï¼

### ç¼ºå°‘çš„æ–‡ä»¶

```
abc.truststore - è¿™æ˜¯ä»€ä¹ˆï¼Ÿ
- Java KeyStoreæ ¼å¼ï¼Ÿ
- åŒ…å«å¤šä¸ªæ ¹è¯ä¹¦ï¼Ÿ
- éœ€è¦å¯†ç  "changeit"
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å°è¯•

### æ–¹æ¡ˆ1: æ·»åŠ  abc.truststore â­â­â­â­â­

```
Demoé…ç½®äº†ä¸¤ä¸ªè¯ä¹¦æ–‡ä»¶:
1. TrustPay.cer
2. abc.truststore (å¯†ç : changeit)

æˆ‘ä»¬åªæ·»åŠ äº†ç¬¬ä¸€ä¸ªï¼Œå¯èƒ½éœ€è¦ç¬¬äºŒä¸ªï¼
```

### æ–¹æ¡ˆ2: ä¿®æ”¹è¯ä¹¦åŠ è½½æ–¹å¼ â­â­â­â­

```csharp
// ä¸æŠŠæ ¹è¯ä¹¦æ·»åŠ åˆ°ClientCertificates
// è€Œæ˜¯æ·»åŠ åˆ°è¯ä¹¦é“¾éªŒè¯
var chain = new X509Chain();
chain.ChainPolicy.ExtraStore.Add(trustPayCertificate);
```

### æ–¹æ¡ˆ3: åªå‘é€å•†æˆ·è¯ä¹¦ â­â­â­

```csharp
// åªæ·»åŠ å•†æˆ·è¯ä¹¦ï¼Œæ ¹è¯ä¹¦ç”¨äºå…¶ä»–ç›®çš„
handler.ClientCertificates.Add(merchantCertificate);
```

### æ–¹æ¡ˆ4: ä¿®æ”¹è¯ä¹¦åŠ è½½æ ‡å¿— â­â­â­

```csharp
// å°è¯•ä¸åŒçš„åŠ è½½æ–¹å¼
var certificate = new X509Certificate2(
    certPath,
    password,
    X509KeyStorageFlags.UserKeySet  // æ”¹ç”¨UserKeySet
);
```

### æ–¹æ¡ˆ5: è”ç³»å†œè¡Œ â­â­â­â­â­

æä¾›è¯æ®ï¼š
1. Demoæ—©ä¸Š09:20æˆåŠŸ
2. æˆ‘ä»¬14:59å¤±è´¥
3. é…ç½®100%ä¸€è‡´
4. è¯·æ±‚å·®å¼‚6å°æ—¶ï¼Œå¯èƒ½å†œè¡Œç«¯æœ‰å˜æ›´

---

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› 

### ç¬¬ä¸€ä¼˜å…ˆçº§: ç¼ºå°‘ abc.truststore â­â­â­â­â­

```
Demoé…ç½®:
<add key="TrustStoreFile" value=".../abc.truststore"/>

æˆ‘ä»¬: æ²¡æœ‰é…ç½®è¿™ä¸ªæ–‡ä»¶ï¼
```

**å»ºè®®**: ç«‹å³æ·»åŠ  abc.truststore åˆ°é¡¹ç›®

### ç¬¬äºŒä¼˜å…ˆçº§: æ ¹è¯ä¹¦ä½¿ç”¨æ–¹å¼é”™è¯¯ â­â­â­â­

```
æ ¹è¯ä¹¦å¯èƒ½ä¸åº”è¯¥æ·»åŠ åˆ° ClientCertificates
è€Œåº”è¯¥ç”¨äºè¯ä¹¦é“¾éªŒè¯æˆ–æœåŠ¡å™¨è¯ä¹¦éªŒè¯
```

### ç¬¬ä¸‰ä¼˜å…ˆçº§: å†œè¡ŒæœåŠ¡å™¨ç«¯é…ç½®å˜æ›´ â­â­â­

```
Demoæ—©ä¸ŠæˆåŠŸï¼Œä¸‹åˆå¤±è´¥
æ—¶é—´å·®: çº¦6å°æ—¶
```

---

## ğŸ“ æ€»ç»“

### å·²å®Œæˆ âœ…

- âœ… å¤åˆ¶å†œè¡Œæ ¹è¯ä¹¦ TrustPay.cer
- âœ… ä¿®æ”¹ Program.cs æ·»åŠ æ ¹è¯ä¹¦åˆ° HttpClient
- âœ… ç¼–è¯‘æˆåŠŸ
- âœ… APIå¯åŠ¨æˆåŠŸ

### ä»æœªè§£å†³ âŒ

- âŒ ä»ç„¶è¿”å› 2302 è¯ä¹¦é”™è¯¯
- âŒ å¯èƒ½ç¼ºå°‘ abc.truststore æ–‡ä»¶
- âŒ å¯èƒ½æ ¹è¯ä¹¦ä½¿ç”¨æ–¹å¼ä¸å¯¹

### å¾…éªŒè¯ âºï¸

- âºï¸ Demoæ˜¯å¦è¿˜èƒ½æˆåŠŸ
- âºï¸ abc.truststore çš„ä½œç”¨
- âºï¸ è¯ä¹¦åŠ è½½æ–¹å¼æ˜¯å¦æ­£ç¡®
- âºï¸ å†œè¡Œç«¯æ˜¯å¦æœ‰é…ç½®å˜æ›´

---

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: 
1. æŸ¥æ‰¾å¹¶æ·»åŠ  abc.truststore æ–‡ä»¶
2. éªŒè¯Demoæ˜¯å¦è¿˜èƒ½æˆåŠŸ
3. å°è¯•ä¸åŒçš„è¯ä¹¦é…ç½®æ–¹å¼

---

*æµ‹è¯•æ—¶é—´: 2026å¹´1æœˆ21æ—¥ 14:59-15:00*
*APIè¿›ç¨‹: 32832*
