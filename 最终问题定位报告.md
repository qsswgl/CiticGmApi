# å†œè¡Œæ”¯ä»˜API - æœ€ç»ˆé—®é¢˜å®šä½æŠ¥å‘Š

## ğŸ“… æŠ¥å‘Šæ—¥æœŸ
2026å¹´1æœˆ21æ—¥

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**ä¸ºä»€ä¹ˆDemoèƒ½æˆåŠŸç”ŸæˆPaymentURLï¼Œè€Œæˆ‘ä»¬çš„é¡¹ç›®è¿”å›2302è¯ä¹¦é”™è¯¯ï¼Ÿ**

---

## ğŸ” å®Œæ•´è°ƒæŸ¥è¿‡ç¨‹

### é˜¶æ®µ1: åˆæ­¥å¯¹é½ (å·²å®Œæˆâœ…)

1. âœ… ä¿®æ”¹PaymentTypeä»"A"æ”¹ä¸º"1" 
2. âœ… ç¡®è®¤ç­¾åç®—æ³•SHA1withRSA
3. âœ… ç¡®è®¤ç¼–ç UTF-8
4. âœ… ç¡®è®¤æ‰€æœ‰é…ç½®å‚æ•°ä¸Demoä¸€è‡´
5. âœ… æ·»åŠ å®¢æˆ·ç«¯è¯ä¹¦åˆ°HttpClient

**ç»“æœ**: ä»è¿”å›2302é”™è¯¯

### é˜¶æ®µ2: æ·»åŠ å†œè¡Œæ ¹è¯ä¹¦ (åˆšå®Œæˆâœ…)

1. âœ… å¤åˆ¶TrustPay.ceråˆ°é¡¹ç›®
2. âœ… ä¿®æ”¹Program.csæ·»åŠ æ ¹è¯ä¹¦
3. âœ… ç¼–è¯‘æˆåŠŸï¼ŒAPIå¯åŠ¨æˆåŠŸ

**ç»“æœ**: **ä»è¿”å›2302é”™è¯¯** âŒ

---

## ğŸ’¡ å…³é”®å‘ç°

### Demoçš„å®Œæ•´è¯ä¹¦é…ç½®

ä» `Web.config` ä¸­å‘ç°Demoé…ç½®äº†**3ä¸ª**è¯ä¹¦æ–‡ä»¶ï¼š

```xml
<!-- 1. å†œè¡Œå…¬é’¥è¯ä¹¦ -->
<add key="TrustPayCertFile" value="K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\TrustPay.cer"/>

<!-- 2. å†œè¡Œæ ¹è¯ä¹¦åº“ (Java KeyStore) -->
<add key="TrustStoreFile" value="K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\abc.truststore"/>
<add key="TrustStorePassword" value="changeit"/>

<!-- 3. å•†æˆ·è¯ä¹¦ -->
<add key="MerchantCertFile" value="K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\103881636900016.pfx"/>
<add key="MerchantCertPassword" value="ay365365"/>
```

### æˆ‘ä»¬çš„é…ç½®

âŒ **åªé…ç½®äº†2ä¸ª**:
1. âœ… TrustPay.cer - **åˆšæ·»åŠ **
2. âŒ abc.truststore - **ç¼ºå°‘ï¼**
3. âœ… 103881636900016.pfx - å·²æœ‰

---

## ğŸš¨ æ ¹æœ¬åŸå› 

### ç¼ºå°‘ abc.truststore æ–‡ä»¶ï¼

**æ–‡ä»¶ä¿¡æ¯**:
```
ä½ç½®: K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\abc.truststore
å¤§å°: 5788 å­—èŠ‚
ç±»å‹: Java KeyStore (JKS)
å¯†ç : changeit
```

**abc.truststore çš„ä½œç”¨**:
- Java KeyStoreæ ¼å¼çš„è¯ä¹¦åº“
- åŒ…å«å¤šä¸ªå—ä¿¡ä»»çš„æ ¹è¯ä¹¦å’Œä¸­é—´è¯ä¹¦
- ç”¨äºæ„å»ºå®Œæ•´çš„è¯ä¹¦é“¾
- ç”¨äºéªŒè¯æœåŠ¡å™¨è¯ä¹¦

**ä¸ºä»€ä¹ˆé‡è¦**:
```
HTTPSåŒå‘è®¤è¯éœ€è¦å®Œæ•´çš„è¯ä¹¦é“¾:

å®¢æˆ·ç«¯å‘é€:
  å•†æˆ·è¯ä¹¦ (103881636900016.pfx)
     â†“
  ä¸­é—´CAè¯ä¹¦ (å¯èƒ½åœ¨truststoreä¸­)
     â†“
  æ ¹CAè¯ä¹¦ (TrustPay.cer + truststoreä¸­çš„å…¶ä»–æ ¹è¯ä¹¦)

å¦‚æœè¯ä¹¦é“¾ä¸å®Œæ•´ â†’ æœåŠ¡å™¨éªŒè¯å¤±è´¥ â†’ 2302é”™è¯¯
```

---

## ğŸ“Š Demo vs æˆ‘ä»¬é¡¹ç›®å¯¹æ¯”

| é…ç½®é¡¹ | Demo | æˆ‘ä»¬çš„é¡¹ç›® | çŠ¶æ€ |
|--------|------|-----------|------|
| å•†æˆ·è¯ä¹¦ | âœ… 103881636900016.pfx | âœ… 103881636900016.pfx | âœ… ä¸€è‡´ |
| TrustPayè¯ä¹¦ | âœ… TrustPay.cer | âœ… TrustPay.cer | âœ… å·²æ·»åŠ  |
| **TrustStore** | âœ… **abc.truststore** | âŒ **ç¼ºå°‘** | âŒ **å…³é”®å·®å¼‚** |
| å•†æˆ·å· | âœ… 103881636900016 | âœ… 103881636900016 | âœ… ä¸€è‡´ |
| ç¯å¢ƒ | âœ… pay.abchina.com | âœ… pay.abchina.com | âœ… ä¸€è‡´ |
| PaymentType | âœ… "1" | âœ… "1" | âœ… ä¸€è‡´ |

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### å¿…é¡»æ·»åŠ  abc.truststore

**é—®é¢˜**: abc.truststoreæ˜¯Java KeyStoreæ ¼å¼ï¼Œ.NETä¸èƒ½ç›´æ¥ä½¿ç”¨

**æ–¹æ¡ˆA: è½¬æ¢ä¸º.NETæ ¼å¼** â­â­â­â­â­

```powershell
# ä½¿ç”¨keytoolå¯¼å‡ºtruststoreä¸­çš„è¯ä¹¦
keytool -list -keystore abc.truststore -storepass changeit
keytool -export -alias [åˆ«å] -file trusted-cert.cer -keystore abc.truststore -storepass changeit

# ç„¶ååœ¨.NETä¸­å¯¼å…¥
X509Certificate2 trustedCert = new X509Certificate2("trusted-cert.cer");
```

**æ–¹æ¡ˆB: å¯¼å…¥åˆ°Windowsè¯ä¹¦å­˜å‚¨** â­â­â­â­

```powershell
# å…ˆè½¬æ¢JKSä¸ºPFX
keytool -importkeystore -srckeystore abc.truststore -srcstoretype JKS -destkeystore abc.pfx -deststoretype PKCS12

# å¯¼å…¥åˆ°Windows
Import-PfxCertificate -FilePath abc.pfx -CertStoreLocation Cert:\LocalMachine\Root
```

**æ–¹æ¡ˆC: æ‰‹åŠ¨æ·»åŠ æ‰€æœ‰æ ¹è¯ä¹¦** â­â­â­

```csharp
// ä»truststoreä¸­æå–æ‰€æœ‰è¯ä¹¦å¹¶æ·»åŠ åˆ°è¯ä¹¦é“¾
var chain = new X509Chain();
chain.ChainPolicy.ExtraStore.Add(cert1);
chain.ChainPolicy.ExtraStore.Add(cert2);
// ...
```

---

## ğŸ“‹ å®Œæ•´çš„ä¿®æ­£æ­¥éª¤

### æ­¥éª¤1: æŸ¥çœ‹truststoreå†…å®¹

```powershell
# å®‰è£…Java JDK (å¦‚æœæ²¡æœ‰)
# ç„¶ååˆ—å‡ºtruststoreä¸­çš„æ‰€æœ‰è¯ä¹¦

keytool -list -v -keystore "K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\abc.truststore" -storepass changeit
```

### æ­¥éª¤2: å¯¼å‡ºè¯ä¹¦

```powershell
# å¯¼å‡ºtruststoreä¸­çš„æ¯ä¸ªè¯ä¹¦
keytool -exportcert -alias [è¯ä¹¦åˆ«å] -file [è¾“å‡ºæ–‡ä»¶.cer] -keystore abc.truststore -storepass changeit
```

### æ­¥éª¤3: æ·»åŠ åˆ°é¡¹ç›®

```csharp
// Program.cs
var trustedCerts = new List<X509Certificate2>
{
    new X509Certificate2("K:/payment/AbcPaymentGateway/cert/prod/TrustPay.cer"),
    new X509Certificate2("K:/payment/AbcPaymentGateway/cert/prod/trusted-cert-1.cer"),
    new X509Certificate2("K:/payment/AbcPaymentGateway/cert/prod/trusted-cert-2.cer"),
    // ...
};

foreach (var cert in trustedCerts)
{
    handler.ClientCertificates.Add(cert);
    // æˆ–æ·»åŠ åˆ°è¯ä¹¦é“¾
    // chain.ChainPolicy.ExtraStore.Add(cert);
}
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆDemoèƒ½æˆåŠŸ

### Demoçš„ä¼˜åŠ¿

1. **ä½¿ç”¨å†œè¡Œå®˜æ–¹SDK (TrustPayClient.dll)**
   - SDKå†…éƒ¨å¤„ç†äº†Java KeyStore
   - è‡ªåŠ¨åŠ è½½abc.truststore
   - æ­£ç¡®æ„å»ºè¯ä¹¦é“¾

2. **å®Œæ•´çš„è¯ä¹¦é…ç½®**
   - TrustPay.cer âœ…
   - abc.truststore âœ… (æˆ‘ä»¬ç¼ºå°‘)
   - å•†æˆ·è¯ä¹¦ âœ…

3. **è¯ä¹¦é“¾å®Œæ•´**
   ```
   å•†æˆ·è¯ä¹¦ â†’ ä¸­é—´CA â†’ æ ¹CA (æ¥è‡ªtruststore)
   å®Œæ•´çš„è¯ä¹¦é“¾ â†’ å†œè¡ŒæœåŠ¡å™¨éªŒè¯é€šè¿‡ â†’ æˆåŠŸ
   ```

### æˆ‘ä»¬çš„é—®é¢˜

1. **è¯ä¹¦é“¾ä¸å®Œæ•´**
   ```
   å•†æˆ·è¯ä¹¦ â†’ ??? â†’ ???
   ä¸å®Œæ•´çš„è¯ä¹¦é“¾ â†’ å†œè¡ŒæœåŠ¡å™¨éªŒè¯å¤±è´¥ â†’ 2302é”™è¯¯
   ```

2. **ç¼ºå°‘abc.truststore**
   - æ— æ³•æ„å»ºå®Œæ•´çš„è¯ä¹¦é“¾
   - æœåŠ¡å™¨æ— æ³•éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„æœ‰æ•ˆæ€§

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### ä¼˜å…ˆçº§1: åˆ†æabc.truststore â­â­â­â­â­

```powershell
# ç«‹å³æ‰§è¡Œ
keytool -list -v -keystore "K:\payment\ç»¼åˆæ”¶é“¶å°æ¥å£åŒ…NETç‰ˆ\cert\prod\abc.truststore" -storepass changeit > truststore-content.txt
```

æŸ¥çœ‹åŒ…å«å“ªäº›è¯ä¹¦ï¼Œæ˜¯å¦æœ‰ï¼š
- å†œè¡Œæ ¹CA
- ä¸­é—´CAè¯ä¹¦
- å…¶ä»–ä¿¡ä»»çš„è¯ä¹¦

### ä¼˜å…ˆçº§2: å¯¼å‡ºå¹¶æ·»åŠ è¯ä¹¦ â­â­â­â­â­

```powershell
# å¯¼å‡ºæ‰€æœ‰è¯ä¹¦
# ç„¶åæ·»åŠ åˆ°.NETé¡¹ç›®çš„è¯ä¹¦é›†åˆ
```

### ä¼˜å…ˆçº§3: éªŒè¯è¯ä¹¦é“¾ â­â­â­â­

```csharp
// æ„å»ºå¹¶éªŒè¯è¯ä¹¦é“¾
var chain = new X509Chain();
chain.ChainPolicy.ExtraStore.Add(...);
bool isValid = chain.Build(merchantCertificate);

if (!isValid)
{
    // è®°å½•è¯ä¹¦é“¾é”™è¯¯
    foreach (var status in chain.ChainStatus)
    {
        logger.LogError("è¯ä¹¦é“¾é”™è¯¯: {Status}", status.StatusInformation);
    }
}
```

---

## ğŸ“ æ€»ç»“

### é—®é¢˜å®šä½

âœ… **å·²æ‰¾åˆ°æ ¹æœ¬åŸå› **:
```
Demoé…ç½®äº†3ä¸ªè¯ä¹¦æ–‡ä»¶:
1. TrustPay.cer (å†œè¡Œå…¬é’¥)
2. abc.truststore (ä¿¡ä»»çš„æ ¹è¯ä¹¦åº“) â† æˆ‘ä»¬ç¼ºå°‘è¿™ä¸ªï¼
3. å•†æˆ·è¯ä¹¦.pfx

æˆ‘ä»¬åªé…ç½®äº†2ä¸ª:
1. TrustPay.cer âœ…
2. å•†æˆ·è¯ä¹¦.pfx âœ…
3. abc.truststore âŒ ç¼ºå°‘ï¼

ç»“æœ: è¯ä¹¦é“¾ä¸å®Œæ•´ â†’ 2302é”™è¯¯
```

### å·²å®Œæˆçš„å·¥ä½œ

1. âœ… ä¿®æ”¹PaymentTypeä¸º"1"
2. âœ… ç¡®è®¤æ‰€æœ‰é…ç½®å‚æ•°
3. âœ… æ·»åŠ å®¢æˆ·ç«¯è¯ä¹¦
4. âœ… æ·»åŠ TrustPay.ceræ ¹è¯ä¹¦
5. âœ… æ‰¾åˆ°ç¼ºå°‘çš„abc.truststoreæ–‡ä»¶

### ä¸‹ä¸€æ­¥

ğŸ¯ **å¿…é¡»å¤„ç†abc.truststore**:
1. ä½¿ç”¨keytoolæŸ¥çœ‹å†…å®¹
2. å¯¼å‡ºå…¶ä¸­çš„è¯ä¹¦
3. æ·»åŠ åˆ°.NETé¡¹ç›®
4. æ„å»ºå®Œæ•´çš„è¯ä¹¦é“¾

### é¢„æœŸç»“æœ

ä¸€æ—¦æ·»åŠ abc.truststoreä¸­çš„è¯ä¹¦:
```
å®Œæ•´è¯ä¹¦é“¾ â†’ å†œè¡ŒæœåŠ¡å™¨éªŒè¯é€šè¿‡ â†’ PaymentURLç”ŸæˆæˆåŠŸ âœ…
```

---

## ğŸ‰ é‡è¦å‘ç°

**Demoèƒ½æˆåŠŸçš„çœŸæ­£åŸå› **:

ä¸ä»…ä»…æ˜¯å› ä¸ºä½¿ç”¨å®˜æ–¹SDKï¼Œè€Œæ˜¯å› ä¸º**Demoé…ç½®äº†å®Œæ•´çš„è¯ä¹¦é“¾**ï¼

æˆ‘ä»¬ä¹‹å‰çš„æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯æ­£ç¡®çš„ï¼š
- âœ… PaymentType="1"
- âœ… ç­¾åç®—æ³•SHA1withRSA  
- âœ… ç¼–ç UTF-8
- âœ… å®¢æˆ·ç«¯è¯ä¹¦
- âœ… TrustPayæ ¹è¯ä¹¦

**ä½†ç¼ºå°‘äº†æœ€å…³é”®çš„**: abc.truststoreï¼

è¿™ä¸ªæ–‡ä»¶åŒ…å«æ„å»ºå®Œæ•´è¯ä¹¦é“¾æ‰€éœ€çš„æ‰€æœ‰ä¿¡ä»»æ ¹è¯ä¹¦ã€‚

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026å¹´1æœˆ21æ—¥ 15:05*
*å…³é”®å‘ç°: Demoä½¿ç”¨äº†3ä¸ªè¯ä¹¦æ–‡ä»¶ï¼Œæˆ‘ä»¬åªç”¨äº†2ä¸ªï¼*
*ä¸‹ä¸€æ­¥: å¤„ç†abc.truststoreæ–‡ä»¶*
